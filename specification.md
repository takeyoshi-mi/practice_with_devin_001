# 英会話サービス管理画面システム仕様書

**作成者:** Takeyoshi Mizusawa

## 達成したい目的

英会話サービスの運営スタッフが生徒情報を効率的に管理し、レッスンチケットの付与などの業務を安全かつ簡単に実行できる管理画面システムを構築する。

### 主要な目的

- **生徒情報の一元管理** - 生徒の基本情報、プラン情報、残チケット数を一箇所で確認
- **レッスンチケット管理** - 管理者による生徒へのチケット付与機能
- **権限管理** - 管理者と一般ユーザーの2段階権限による適切なアクセス制御
- **セキュアなアクセス** - Google OAuth認証とIP制限による安全な管理画面

## 実現方法

### 技術スタック

**バックエンド:** PHP on Laravel 12.x + Filament 3.3

**フロントエンド:**
- Filamentの標準コンポーネントのみを使用（カスタムコンポーネントは原則作成しない）
- Tailwind CSS: Filament標準のユーティリティクラスのみ使用
- Alpine.js: Filament内部で使用（直接記述は避ける）
- Livewire: Filamentが内部的に使用（直接の Livewire コンポーネント作成は避ける）

**認証:** Filament標準認証 + Google OAuth (Laravel Socialite)

**権限管理:** Filament Shield (Spatie Permission統合RBAC)

**データベース:** MySQL 8.0 (本番: Aurora MySQL)

**インフラ:** AWS (ECS Fargate, ALB, VPC)

**開発環境:** Laravel Sail (Docker)

## ユースケース

### UC0: 初期管理者アカウントの作成

**アクター:** システム管理者  
**前提条件:** システムが初期セットアップ済み、まだ管理者アカウントが存在しない

**基本フロー:**
1. ブラウザで管理画面URL（/admin）にアクセス
2. 初期セットアップ画面が表示される
3. 管理者の名前、メールアドレスを入力
4. Googleアカウントで認証を行う
5. システムが管理者アカウントを作成
6. ダッシュボード画面へ自動的に遷移

### UC1: 管理者ログイン

**アクター:** 管理者、一般ユーザー  
**前提条件:** ユーザーアカウントが作成されている

**基本フロー:**
1. ユーザーが管理画面URL（/admin）にアクセス
2. Googleアカウントでログイン
3. システムが権限を確認し、ダッシュボードを表示

### UC2: 生徒一覧の確認

**アクター:** 管理者、一般ユーザー

**基本フロー:**
1. ダッシュボードから「生徒管理」メニューを選択
2. 生徒一覧画面が表示される
3. 検索・フィルター機能で特定の生徒を検索

### UC3: レッスンチケット付与

**アクター:** 管理者のみ

**基本フロー:**
1. 生徒詳細画面を開く
2. 「チケット付与」ボタンをクリック
3. 付与するチケット数を入力
4. 確認モーダルで内容を確認
5. 「付与する」ボタンでチケット付与実行

### UC4: ユーザーアカウント管理

**アクター:** 管理者のみ

**基本フロー:**
1. 「ユーザー管理」メニューからユーザー一覧を表示
2. 新規ユーザーの追加または既存ユーザーの編集
3. 権限（管理者/一般ユーザー）を設定

## 機能要求

### 1. 認証機能

**Google OAuth認証**
- Laravel Socialiteを使用したGoogle認証
- 初回ログイン時の自動ユーザー作成（要権限付与）
- セッション管理

### 2. 権限管理機能

**役割ベースアクセス制御（RBAC）**
- **管理者:** 全機能へのアクセス権限（ユーザー管理、生徒管理、チケット付与）
- **一般ユーザー:** 生徒情報の閲覧のみ（チケット付与不可、ユーザー管理不可）

**Filament Shield統合**
- リソース単位での権限設定
- ページ・ウィジェット単位でのアクセス制御

### 3. 生徒管理機能

**生徒一覧表示**
- ページネーション（25件/ページ）
- 検索機能（ID、名前、メール）
- ソート機能（各カラム）

**生徒詳細表示**
- ユーザー情報表示
- 現在のプラン情報表示
- 残レッスンチケット数表示

### 4. チケット管理機能

**チケット付与**
- 数値入力フォーム
- 確認モーダル表示
- 付与履歴の記録

**チケット履歴**
- 付与日時、付与者、付与数の記録

## 期待する振舞

### Feature: 初期管理者アカウント作成

```gherkin
Feature: 初期管理者アカウント作成
  システム管理者として
  私は初期管理者アカウントを作成したい
  なぜならシステムを利用開始するために必要だから

  Scenario: Webブラウザでの初期管理者作成
    Given システムの初期セットアップが完了している
    And まだ管理者アカウントが存在しない
    When 私がブラウザで"/admin"にアクセスする
    Then 初期セットアップ画面が表示される
    And "管理者アカウントを作成してください"というメッセージが表示される
    When 以下の情報を入力する:
      | フィールド | 入力値                |
      | 名前      | 管理太郎              |
      | メール    | admin@example.com    |
    And "Googleアカウントで認証"ボタンをクリックする
    And Googleアカウントで認証を承認する
    Then 管理者アカウントが作成される
    And 管理者権限が自動的に付与される
    And ダッシュボード画面が表示される
    And "管理者アカウントを作成しました"という成功メッセージが表示される

  Scenario: 2人目以降のユーザー作成時
    Given すでに管理者アカウントが1つ以上存在する
    When 新規ユーザーがブラウザで"/admin"にアクセスする
    Then 通常のログイン画面が表示される
    And 初期セットアップ画面は表示されない
    When "Googleでログイン"ボタンをクリックする
    And Googleアカウントで認証を承認する
    Then "アクセス権限がありません。管理者に連絡してください"というメッセージが表示される
    And ユーザーアカウントは作成されない
```

### Feature: ユーザー認証

```gherkin
Feature: ユーザー認証
  ユーザーとして
  私は管理画面にログインしたい
  なぜなら生徒情報を確認する必要があるから

  Background:
    Given ユーザーアカウントが存在する
    And Google OAuth設定が完了している

  Scenario: Googleアカウントでのログイン成功
    Given 私は管理画面のログインページにいる
    When "Googleでログイン"ボタンをクリックする
    And Googleアカウントで認証を承認する
    Then ダッシュボード画面が表示される
    And ナビゲーションメニューに私の名前が表示される

  Scenario: 未登録ユーザーのログイン試行
    Given 私はユーザーとして登録されていない
    When 私がGoogleアカウントでログインを試みる
    Then エラーメッセージ"アクセス権限がありません"が表示される
    And ログインページにリダイレクトされる

  Scenario: セッションタイムアウト後のアクセス
    Given 私はログイン済みである
    And 最後の操作から8時間以上経過している
    When 管理画面の任意のページにアクセスする
    Then ログインページにリダイレクトされる
    And "セッションがタイムアウトしました"というメッセージが表示される
```

### Feature: 生徒管理

```gherkin
Feature: 生徒管理
  ユーザーとして
  私は生徒情報を閲覧・検索したい
  なぜなら適切なサポートを提供する必要があるから

  Background:
    Given 私はユーザーとしてログインしている
    And システムに以下の生徒が存在する:
      | ID    | ニックネーム | 名前     | メール               | 残チケット |
      | 10001 | taro123     | 田中太郎 | taro@example.com     | 5         |
      | 10002 | hanako456   | 山田花子 | hanako@example.com   | 10        |
      | 10003 | ken789      | 佐藤健   | ken@example.com      | 0         |

  Scenario: 生徒一覧の表示
    When 私は"生徒管理"メニューをクリックする
    Then 生徒一覧画面が表示される
    And 以下の情報が表形式で表示される:
      | ID | ニックネーム | 名前 | メール | 残チケット |
    And 1ページあたり25件の生徒が表示される

  Scenario: 生徒の検索（名前）
    Given 私は生徒一覧画面にいる
    When 検索フィールドに"田中"と入力する
    And Enterキーを押す
    Then "田中太郎"の情報が表示される
    And "山田花子"の情報は表示されない

  Scenario: 生徒の検索（メール）
    Given 私は生徒一覧画面にいる
    When 検索フィールドに"hanako@example.com"と入力する
    And Enterキーを押す
    Then "山田花子"の情報のみが表示される

  Scenario: 生徒詳細の表示
    Given 私は生徒一覧画面にいる
    When "田中太郎"の行の"詳細"リンクをクリックする
    Then 生徒詳細画面が表示される
    And 以下の情報が表示される:
      | 項目           | 値                  |
      | ID            | 10001              |
      | ニックネーム   | taro123            |
      | 名前          | 田中太郎           |
      | メールアドレス | taro@example.com   |
      | 残チケット数   | 5                  |
    And 現在のプラン情報が表示される

  Scenario: 一般ユーザーの生徒詳細画面
    Given 私は一般ユーザーとしてログインしている
    When 私は田中太郎の生徒詳細画面にいる
    Then "チケット付与"ボタンは表示されない
    And 生徒情報は閲覧のみ可能である
```

### Feature: レッスンチケット付与

```gherkin
Feature: レッスンチケット付与
  管理者として
  私は生徒にレッスンチケットを付与したい
  なぜならレッスン受講の権利を提供する必要があるから

  Background:
    Given 私は管理者としてログインしている
    And 生徒"田中太郎"（ID: 10001）が存在する
    And 田中太郎の現在の残チケット数は5枚である

  Scenario: チケット付与の成功
    Given 私は田中太郎の生徒詳細画面にいる
    When "チケット付与"ボタンをクリックする
    And チケット数フィールドに"3"と入力する
    And "確認"ボタンをクリックする
    Then 確認モーダルが表示される
    And モーダルに以下の情報が表示される:
      | 項目               | 値 |
      | 付与チケット数     | 3  |
      | 現在の残チケット数 | 5  |
      | 付与後の残チケット数| 8  |
    When "付与する"ボタンをクリックする
    Then "チケットを付与しました"という成功メッセージが表示される
    And 生徒の残チケット数が8枚に更新される
    And チケット履歴に付与記録が追加される

  Scenario: チケット付与のキャンセル
    Given 私は田中太郎の生徒詳細画面にいる
    When "チケット付与"ボタンをクリックする
    And チケット数フィールドに"3"と入力する
    And "確認"ボタンをクリックする
    And 確認モーダルが表示される
    When "キャンセル"ボタンをクリックする
    Then モーダルが閉じられる
    And 生徒の残チケット数は5枚のままである

  Scenario: 無効なチケット数の入力
    Given 私は田中太郎の生徒詳細画面にいる
    When "チケット付与"ボタンをクリックする
    And チケット数フィールドに"-1"と入力する
    Then "1以上の数値を入力してください"というエラーメッセージが表示される
    And "確認"ボタンは無効化される

  Scenario: チケット付与権限がない場合
    Given 私は一般ユーザーとしてログインしている
    And 私は田中太郎の生徒詳細画面にいる
    Then "チケット付与"ボタンは表示されない
```

### Feature: ユーザーアカウント管理

```gherkin
Feature: ユーザーアカウント管理
  管理者として
  私はユーザーアカウントを管理したい
  なぜなら適切な権限管理が必要だから

  Background:
    Given 私は管理者としてログインしている
    And システムに以下のユーザーが存在する:
      | 名前     | メール             | 役割         |
      | 管理太郎 | admin@example.com  | 管理者       |
      | 一般花子 | user@example.com   | 一般ユーザー |

  Scenario: 新規ユーザーの追加
    Given 私はユーザー一覧画面にいる
    When "新規ユーザー追加"ボタンをクリックする
    And 以下の情報を入力する:
      | フィールド | 値                   |
      | 名前      | 新規ユーザー          |
      | メール    | newuser@example.com  |
      | 役割      | 一般ユーザー          |
    And "保存"ボタンをクリックする
    Then "ユーザーを追加しました"という成功メッセージが表示される
    And ユーザー一覧に"新規ユーザー"が表示される

  Scenario: ユーザーの権限変更
    Given 私はユーザー一覧画面にいる
    When "一般花子"の"編集"ボタンをクリックする
    And 役割を"管理者"に変更する
    And "更新"ボタンをクリックする
    Then "権限を更新しました"という成功メッセージが表示される
    And 一般花子の役割が"管理者"として表示される

  Scenario: 一般ユーザーによるユーザー管理へのアクセス試行
    Given 私は一般ユーザーとしてログインしている
    When 私が"/admin/users"にアクセスする
    Then "アクセス権限がありません"というエラーメッセージが表示される
    And ダッシュボードにリダイレクトされる
```

## 画面設計

### 1. ログイン画面

- Filament標準ログイン画面
- 「Googleでログイン」ボタン追加
- ロゴ表示

### 2. 生徒一覧画面

- 検索バー
- データテーブル（Filament Table Builder）
- カラム: ID、ニックネーム、名前、メール、残チケット数、アクション
- ページネーション

### 3. 生徒詳細画面

- 基本情報セクション
- プラン情報セクション
- チケット付与ボタン
- チケット履歴テーブル

### 4. チケット付与モーダル

- チケット数入力フィールド
- 現在の残チケット数表示
- 付与後の残チケット数プレビュー
- 確認・キャンセルボタン